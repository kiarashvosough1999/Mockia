name: master_workflow2

on:
  push:
    branches:
      - '**'

env:
  DocC_Derived_Data_Path_Build: .doc_build
  DocC_Find_Executable_Path: $(xcrun --find docc)
  Swift_SPM_Build_Path: .swiftspm
  DocC_Static_Site_Build_Ouptput_Path: ../docc_static_site
  Jekyll_Static_Site_Destination_Path: ../docc_static_site/_site
  Package_Name: $(basename "$PWD")
  Docc_Generated_Archive_Path: $(find . -regex '.*/[^/]*.doccarchive')

jobs:
  build:

    runs-on: macos-12

    steps:

    - uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: latest-stable

    - name: update swift
      uses: swift-actions/setup-swift@v1

    - name: checkout
      uses: actions/checkout@v3
      with:
       repository: ${{ github.event.pull_request.head.repo.full_name }}
       ref: ${{ github.event.pull_request.head.ref }}

    - name: Build
      run: |
        swift build -v

    - name: Run tests
      run: |
        swift test -v

    - name: Prepare Building DocC
      run: |
        mkdir $DocC_Derived_Data_Path_Build  # Create a directory for derived data of build
        mkdir $DocC_Static_Site_Build_Ouptput_Path  # Create a directory to save static site which was generated by DocC

    - name: Build DocC
      needs: Prepare Building DocC
      run: |

        xcodebuild docbuild -scheme $Package_Name -derivedDataPath $DocC_Derived_Data_Path_Build -destination 'platform=iOS Simulator,name=iPhone 13'

        echo "DocC Archeive Build Succeed"

        $docc_executable_path process-archive transform-for-static-hosting $Docc_Generated_Archive_Path --output-path $DocC_Static_Site_Build_Ouptput_Path --hosting-base-path $Package_Name

        echo "DocC Static Site Generated, Succeed"

    - name: Build Static Site With Jekyll
      permissions:
        pages: write
        contents: read
      needs: Build DocC
      uses: actions/jekyll-build-pages@v1
      with:
        source: $DocC_Static_Site_Build_Ouptput_Path
        destination: $Jekyll_Static_Site_Destination_Path
    
    - name: Upload Static Site Artifacts
      permissions:
        pages: write
        contents: read
      needs: Build Static Site With Jekyll
      uses: actions/upload-pages-artifact@v0
      with:
        path: $Jekyll_Static_Site_Destination_Path
        retention-days: 1

    - name: Deploy
      needs: Upload Static Site Artifacts
      permissions:
        contents: read
        pages: write
        id-token: write
      uses: actions/deploy-pages@v1
      with:
        emit_telemetry: false
        timeout: 600000
        error_count: 10
        reporting_interval: 5000
        artifact_name: github-pages
